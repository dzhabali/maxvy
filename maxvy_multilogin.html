<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–í–∞–¥–∂—Ä–∞–π–æ–≥–∏–Ω–∏ ‚Äî —Ç—Ä–µ–∫–µ—Ä (Email + Firestore)</title>
<style>
  :root{--bg:#f8f9fa;--card:#fff;--line:#e5e7eb;--muted:#6b7280;--head:#e9ecef;--accent:#198754;--accent2:#157347;--slot-empty:#f1f3f5;--slot-current:#d8f5d0}
  body{margin:0;background:var(--bg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .topbar{position:sticky;top:0;background:var(--card);padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:1px solid #ccc;z-index:10}
  .title{font-weight:700}
  .spacer{flex:1}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
  button{padding:6px 12px;border:none;background:var(--accent);color:#fff;border-radius:6px;cursor:pointer}
  button:hover{background:var(--accent2)}
  button[disabled]{opacity:.6;cursor:default}
  input,select{padding:6px 8px;border:1px solid var(--line);border-radius:6px;background:var(--card)}
  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid var(--line);padding:6px;text-align:center}
  th{background:var(--head);position:sticky;top:56px;z-index:5}
  tr.empty-slot{background:var(--slot-empty)}
  tr.current-slot{background:var(--slot-current)}
  input[type="number"]{width:72px}
  .stats{padding:12px;background:var(--card);border-top:1px solid #ccc;margin-top:10px}
  .auth{display:flex;gap:8px;align-items:center}
  .auth input{width:180px}
  .note{color:var(--muted);font-size:12px}
</style>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
// üîë –í–°–¢–ê–í–¨ –°–í–û–ò –ö–õ–Æ–ß–ò –ò–ó FIREBASE (Project settings ‚Üí Web app):
const firebaseConfig = {
  apiKey: "AIzaSyAYeb4qPZSHAdDqMxneVYtdFsy-hsuSbVs",
  authDomain: "vy-tracker.firebaseapp.com",
  projectId: "vy-tracker",
  storageBucket: "vy-tracker.firebasestorage.app",
  messagingSenderId: "140906721201",
  appId: "1:140906721201:web:c17603021a784fe5e01790",
  measurementId: "G-Z4ZXW1N1WN"
};
// ‚Äî‚Äî‚Äî‚Äî
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
firebase.firestore().enablePersistence().catch(()=>{});

// helpers
function slotTime(i){const h=String(Math.floor(i/4)).padStart(2,'0');const m=String((i%4)*15).padStart(2,'0');return `${h}:${m}`;}
function emptyDay(){return Array.from({length:96},(_,i)=>({time:slotTime(i),vy:false,vyAround:false,sleep:false,count:0}))}
function dayDocRef(uid,dateStr){return db.collection('users').doc(uid).collection('days').doc(dateStr)}
</script>
</head>
<body>

<div class="topbar">
  <span class="title">–í–∞–¥–∂—Ä–∞–π–æ–≥–∏–Ω–∏ ‚Äî —Ç—Ä–µ–∫–µ—Ä</span>
  <input type="date" id="datePicker" />
  <button id="markSleep">–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å—ë –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∫ —Å–æ–Ω</button>
  <div class="spacer"></div>
  <span id="authState" class="badge">–Ω–µ –≤–æ—à–ª–∞</span>
  <span id="userInfo" class="note"></span>
  <div class="auth" id="authBox">
    <input type="email" id="email" placeholder="email">
    <input type="password" id="pwd" placeholder="–ø–∞—Ä–æ–ª—å">
    <button id="btnSignIn" title="–≤–æ–π—Ç–∏">–í–æ–π—Ç–∏</button>
    <button id="btnSignUp" title="—Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç">–°–æ–∑–¥–∞—Ç—å</button>
    <button id="btnReset" title="–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å">–ó–∞–±—ã–ª–∏?</button>
    <button id="btnLogout" style="display:none;">–í—ã–π—Ç–∏</button>
  </div>
  <button id="exportDay" disabled>–≠–∫—Å–ø–æ—Ä—Ç –¥–Ω—è</button>
  <button id="exportAll" disabled>–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏</button>
</div>

<div id="tableContainer"></div>
<div class="stats" id="stats"></div>

<script>
const datePicker     = document.getElementById('datePicker');
const tableContainer = document.getElementById('tableContainer');
const statsDiv       = document.getElementById('stats');
const btnSleep       = document.getElementById('markSleep');
const btnExportDay   = document.getElementById('exportDay');
const btnExportAll   = document.getElementById('exportAll');
const authState      = document.getElementById('authState');
const userInfo       = document.getElementById('userInfo');
const emailEl        = document.getElementById('email');
const pwdEl          = document.getElementById('pwd');
const btnSignIn      = document.getElementById('btnSignIn');
const btnSignUp      = document.getElementById('btnSignUp');
const btnReset       = document.getElementById('btnReset');
const btnLogout      = document.getElementById('btnLogout');

datePicker.valueAsDate = new Date();

let uid = null, unsubDay = null, dayCache = null;

// ‚Äî‚Äî AUTH (email/password)
btnSignUp.onclick = async ()=>{
  try{
    const {user} = await auth.createUserWithEmailAndPassword(emailEl.value.trim(), pwdEl.value);
    alert('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –í—ã –≤–æ—à–ª–∏.');
  }catch(e){ alert(e.message); }
};
btnSignIn.onclick = async ()=>{
  try{
    const {user} = await auth.signInWithEmailAndPassword(emailEl.value.trim(), pwdEl.value);
  }catch(e){ alert(e.message); }
};
btnReset.onclick = async ()=>{
  try{
    await auth.sendPasswordResetEmail(emailEl.value.trim());
    alert('–ü–∏—Å—å–º–æ –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.');
  }catch(e){ alert(e.message); }
};
btnLogout.onclick = async ()=>{
  if (unsubDay){unsubDay();unsubDay=null}
  await auth.signOut();
};

auth.onAuthStateChanged(user=>{
  if (user){
    uid = user.uid;
    authState.textContent = '–≤ —Å–µ—Ç–∏';
    userInfo.textContent  = user.email ? ` ¬∑ ${user.email}` : '';
    btnLogout.style.display=''; btnSignIn.style.display='none'; btnSignUp.style.display='none'; btnReset.style.display='none'; emailEl.style.display='none'; pwdEl.style.display='none';
    btnExportDay.disabled=false; btnExportAll.disabled=false;
    attachDayListener(datePicker.value);
  } else {
    uid = null;
    authState.textContent = '–Ω–µ –≤–æ—à–ª–∞';
    userInfo.textContent  = '';
    btnLogout.style.display='none'; btnSignIn.style.display=''; btnSignUp.style.display=''; btnReset.style.display=''; emailEl.style.display=''; pwdEl.style.display='';
    btnExportDay.disabled=true; btnExportAll.disabled=true;
    if (unsubDay){unsubDay();unsubDay=null}
    dayCache=null; renderTable();
  }
});

// ‚Äî‚Äî DATA
function attachDayListener(dateStr){
  if (!uid) return;
  if (unsubDay){unsubDay();unsubDay=null}
  unsubDay = dayDocRef(uid,dateStr).onSnapshot(async snap=>{
    if (snap.exists){ dayCache = snap.data().slots || emptyDay(); }
    else{
      const slots = emptyDay();
      await dayDocRef(uid,dateStr).set({slots, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
      dayCache = slots;
    }
    renderTable();
  }, err=>console.error(err));
}

function renderTable(){
  const dateStr = datePicker.value;
  const now = new Date();
  const isToday = dateStr === now.toISOString().slice(0,10);
  const currentSlot = isToday ? Math.floor((now.getHours()*60+now.getMinutes())/15) : -1;
  const slots = dayCache || emptyDay();

  let html = '<table><thead><tr><th>–í—Ä–µ–º—è</th><th>–ß—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ –í–ô</th><th>–í–∏–¥–µ–ª–∞ –í–ô</th><th>–°–æ–Ω</th><th>–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Å–ø–æ–º–∏–Ω–∞–ª–∞</th></tr></thead><tbody>';
  slots.forEach((s,idx)=>{
    const empty = !s.vy && !s.vyAround && !s.sleep && !s.count;
    const cls = `${empty?'empty-slot':''} ${idx===currentSlot?'current-slot':''}`.trim();
    html += `<tr class="${cls}">
      <td>${s.time}</td>
      <td><input type="checkbox" data-idx="${idx}" data-field="vy" ${s.vy?'checked':''}></td>
      <td><input type="checkbox" data-idx="${idx}" data-field="vyAround" ${s.vyAround?'checked':''}></td>
      <td><input type="checkbox" data-idx="${idx}" data-field="sleep" ${s.sleep?'checked':''}></td>
      <td><input type="number" min="0" data-idx="${idx}" data-field="count" value="${s.count}"></td>
    </tr>`;
  });
  html += '</tbody></table>';
  tableContainer.innerHTML = html;

  if (currentSlot>=0 && !renderTable._scrolled){
    const row = tableContainer.querySelectorAll('tr')[currentSlot+1];
    if (row){ row.scrollIntoView({behavior:'smooth',block:'center'}); renderTable._scrolled = true; }
  }
  updateStats();
}

tableContainer.addEventListener('change', async (e)=>{
  const idx = e.target.dataset.idx, field = e.target.dataset.field;
  if (idx===undefined || !uid) return;
  const dateStr = datePicker.value;
  const slots = (dayCache || emptyDay()).slice();
  if (field==='count'){ slots[idx][field] = Number(e.target.value)||0; }
  else { slots[idx][field] = e.target.checked; }
  dayCache = slots; renderTable();
  try{
    await dayDocRef(uid,dateStr).set({slots, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
  }catch(err){ console.error(err); }
});

btnSleep.addEventListener('click', async ()=>{
  if (!uid) return;
  const dateStr = datePicker.value;
  const slots = (dayCache || emptyDay()).slice();
  const now = new Date();
  const isToday = dateStr === now.toISOString().slice(0,10);
  const limit = isToday ? Math.floor((now.getHours()*60+now.getMinutes())/15) : slots.length;
  for (let i=0;i<limit;i++) slots[i].sleep = true;
  dayCache = slots; renderTable();
  await dayDocRef(uid,dateStr).set({slots, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
});

function updateStats(){
  const slots = dayCache || emptyDay();
  const total = slots.length;
  const vy = slots.filter(s=>s.vy).length;
  const va = slots.filter(s=>s.vyAround).length;
  const sl = slots.filter(s=>s.sleep).length;
  const sum = slots.reduce((a,s)=>a+(Number(s.count)||0),0);
  statsDiv.innerHTML = `
    –ß—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ –í–ô: ${vy} —Å–ª–æ—Ç–æ–≤ (${Math.round(vy/total*100)}%)<br>
    –í–∏–¥–µ–ª–∞ –í–ô: ${va} —Å–ª–æ—Ç–æ–≤ (${Math.round(va/total*100)}%)<br>
    –°–æ–Ω: ${sl} —Å–ª–æ—Ç–æ–≤ (${Math.round(sl/total*100)}%)<br>
    –°—É–º–º–∞ ¬´–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Å–ø–æ–º–∏–Ω–∞–ª–∞¬ª: ${sum}
  `;
}

datePicker.addEventListener('change', ()=>{
  renderTable._scrolled = false;
  if (uid) attachDayListener(datePicker.value); else renderTable();
});

// —ç–∫—Å–ø–æ—Ä—Ç
document.getElementById('exportDay').addEventListener('click', async ()=>{
  if (!uid) return;
  const dateStr = datePicker.value;
  const snap = await dayDocRef(uid,dateStr).get();
  const slots = snap.exists ? (snap.data().slots||[]) : [];
  exportCSV({[dateStr]:slots}, `vajrayogini_${dateStr}.csv`);
});
document.getElementById('exportAll').addEventListener('click', async ()=>{
  if (!uid) return;
  const snap = await db.collection('users').doc(uid).collection('days').get();
  const obj={}; snap.forEach(d=>obj[d.id]=d.data().slots||[]);
  exportCSV(obj, `vajrayogini_all.csv`);
});
function exportCSV(obj,filename){
  const rows=[['–î–∞—Ç–∞','–í—Ä–µ–º—è','–ß—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ –í–ô','–í–∏–¥–µ–ª–∞ –í–ô','–°–æ–Ω','–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Å–ø–æ–º–∏–Ω–∞–ª–∞']];
  for (const [date,slots] of Object.entries(obj)){
    (slots||[]).forEach(s=>rows.push([date,s.time,s.vy?'–î–∞':'–ù–µ—Ç',s.vyAround?'–î–∞':'–ù–µ—Ç',s.sleep?'–î–∞':'–ù–µ—Ç',s.count??0]));
  }
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}

// –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
datePicker.valueAsDate = new Date();
renderTable();
</script>
</body>
</html>