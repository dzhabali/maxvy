<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–í–∞–¥–∂—Ä–∞–π–æ–≥–∏–Ω–∏ ‚Äî —Ç—Ä–µ–∫–µ—Ä</title>
<style>
  :root{
    --bg:#f8f9fa;--card:#fff;--line:#e5e7eb;--muted:#6b7280;--head:#e9ecef;
    --accent:#198754;--accent2:#157347;--yellow:#f59e0b;--yellow2:#d97706;
    --graybtn:#6b7280;--graybtn2:#4b5563;--highlight:#d8f5d0;
    --bar0:#94a3b8;--bar1:#22c55e;--bar2:#10b981;--bar3:#06b6d4;--bar4:#f59e0b
  }
  body{margin:0;background:var(--bg);font:16px/1.35 -apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,sans-serif}
  .topbar{position:sticky;top:0;background:var(--card);padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:1px solid #ccc;z-index:20}
  .title{font-weight:700}
  .spacer{flex:1}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
  .note{color:var(--muted);font-size:12px}

  input[type="date"]{padding:8px;border:1px solid var(--line);border-radius:8px;background:var(--card)}
  button{border:none;border-radius:8px;cursor:pointer}
  .btn{padding:8px 12px}
  .btn-sm{padding:6px 10px;font-size:14px}
  .btn-green{background:var(--accent);color:#fff}
  .btn-green:hover{background:var(--accent2)}
  .btn-gray{background:var(--graybtn);color:#fff}
  .btn-gray:hover{background:var(--graybtn2)}
  .btn-yellow{background:var(--yellow);color:#111}
  .btn-yellow:hover{background:var(--yellow2)}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff}

  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--line);padding:10px;text-align:center}
  th{background:var(--head);position:sticky;top:56px;z-index:10}
  tr.current-slot{background:var(--highlight)}
  .marker-row td{background:#fafafa;color:#111;text-align:left;font-size:14px}
  .marker{display:flex;align-items:center;gap:10px}
  .marker .bar{height:6px;border-radius:4px;flex:1;background:#e5e7eb;overflow:hidden}
  .marker .bar > i{display:block;height:100%;background:var(--bar0);width:0}

  .stats{padding:12px;background:var(--card);border-top:1px solid #ccc;margin-top:8px;font-weight:600;position:sticky;bottom:0}
  .progress-wrap{display:flex;align-items:center;gap:10px;margin-top:6px}
  .progress{height:8px;background:#e5e7eb;border-radius:6px;flex:1;overflow:hidden}
  .progress > i{display:block;height:100%;background:var(--bar1);width:0}
  .progress-num{font-size:12px;color:#111}

  /* —Ç–æ—Å—Ç—ã */
  .toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:999;opacity:0;transition:.25s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(8px)}
  /* –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ (–ø—Ä–æ—Å—Ç–∞—è emoji‚Äë–≤–µ—Ä—Å–∏—è) */
  .confetti{position:fixed;left:0;top:0;width:100%;height:0;overflow:visible;pointer-events:none;z-index:998}
  .confetti span{position:absolute;animation:fall 1.4s linear forwards;font-size:18px}
  @keyframes fall{
    0%{transform:translateY(-10px) translateX(0) rotate(0deg);opacity:1}
    100%{transform:translateY(110vh) translateX(var(--dx)) rotate(540deg);opacity:.9}
  }

  /* –≤–µ—Ä—Ö–Ω–∏–π –º–∏–Ω–∏‚Äë–±–∞—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
  .top-progress{position:sticky;top:48px;background:#f8fafc;border-bottom:1px solid #e5e7eb;padding:6px 10px;display:flex;align-items:center;gap:10px;z-index:9}
  .top-progress .mini{height:6px;border-radius:4px;background:#e5e7eb;flex:1;overflow:hidden}
  .top-progress .mini > i{display:block;height:100%;background:var(--bar1);width:0}
  .top-progress .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
</style>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
// üîë —Ç–≤–æ–∏ –∫–ª—é—á–∏
const firebaseConfig = {
  apiKey: "AIzaSyAYeb4qPZSHAdDqMxneVYtdFsy-hsuSbVs",
  authDomain: "vy-tracker.firebaseapp.com",
  projectId: "vy-tracker",
  storageBucket: "vy-tracker.firebasestorage.app",
  messagingSenderId: "140906721201",
  appId: "1:140906721201:web:c17603021a784fe5e01790",
  measurementId: "G-Z4ZXW1N1WN"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
firebase.firestore().enablePersistence().catch(()=>{});

// helpers / data shape
const slotTime = i => `${String(Math.floor(i/4)).padStart(2,'0')}:${String((i%4)*15).padStart(2,'0')}`;
const emptyDay = () => Array.from({length:96},(_,i)=>({time:slotTime(i),count:0,sleep:false,forgot:false}));
const dayRef   = (uid,dateStr)=> db.collection('users').doc(uid).collection('days').doc(dateStr);

// –º–∏–≥—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ (–µ—Å–ª–∏ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ count)
const normalizeSlots = (arr=[]) => (arr.length? arr: emptyDay()).map(s=>({
  time:s.time,
  count:Number(s.count||0),
  sleep: Boolean(s.sleep||false),
  forgot: Boolean(s.forgot||false)
}));

// milestones
const MILESTONES = [25,50,75,100];
</script>
</head>
<body>

<div class="topbar">
  <span class="title">–í–∞–¥–∂—Ä–∞–π–æ–≥–∏–Ω–∏ ‚Äî —Ç—Ä–µ–∫–µ—Ä</span>
  <input type="date" id="datePicker" />
  <button id="markSleep" class="pill" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∫ —Å–æ–Ω">–°–æ–Ω –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</button>
  <div class="spacer"></div>
  <span id="authState" class="badge">–Ω–µ –≤–æ—à–ª–∞</span>
  <span id="userInfo" class="note"></span>
  <div class="auth" id="authBox">
    <input type="email" id="email" placeholder="email" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;width:160px">
    <input type="password" id="pwd" placeholder="–ø–∞—Ä–æ–ª—å" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;width:160px">
    <button id="btnSignIn" class="btn">–í–æ–π—Ç–∏</button>
    <button id="btnSignUp" class="btn" title="—Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç">–°–æ–∑–¥–∞—Ç—å</button>
    <button id="btnReset"  class="btn" title="–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å">–ó–∞–±—ã–ª–∏?</button>
    <button id="btnLogout" class="btn" style="display:none;">–í—ã–π—Ç–∏</button>
  </div>
  <button id="exportDay" class="btn" disabled>–≠–∫—Å–ø–æ—Ä—Ç –¥–Ω—è</button>
  <button id="exportAll" class="btn" disabled>–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏</button>
</div>

<!-- –º–∏–Ω–∏‚Äë–ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–¥ —à–∞–ø–∫–æ–π -->
<div class="top-progress">
  <div class="mini"><i id="miniFill" style="width:0"></i></div>
  <span id="miniChip" class="chip">0/100</span>
</div>

<div id="tableContainer"></div>

<div class="stats" id="stats">
  –ò—Ç–æ–≥–æ +1: 0 ¬∑ –°–æ–Ω: 0 —á ¬∑ –ó–∞–±—ã–ª–∞: 0 —Å–ª–æ—Ç–æ–≤
  <div class="progress-wrap">
    <div class="progress"><i id="footFill" style="width:0"></i></div>
    <span id="footNum" class="progress-num">0/100 (0%)</span>
  </div>
</div>

<div id="toast" class="toast"></div>
<div id="confetti" class="confetti"></div>

<script>
const datePicker     = document.getElementById('datePicker');
const tableContainer = document.getElementById('tableContainer');
const statsDiv       = document.getElementById('stats');
const btnSleep       = document.getElementById('markSleep');
const btnExportDay   = document.getElementById('exportDay');
const btnExportAll   = document.getElementById('exportAll');
const authState      = document.getElementById('authState');
const userInfo       = document.getElementById('userInfo');
const emailEl        = document.getElementById('email');
const pwdEl          = document.getElementById('pwd');
const btnSignIn      = document.getElementById('btnSignIn');
const btnSignUp      = document.getElementById('btnSignUp');
const btnReset       = document.getElementById('btnReset');
const btnLogout      = document.getElementById('btnLogout');
const miniFill       = document.getElementById('miniFill');
const miniChip       = document.getElementById('miniChip');
const footFill       = document.getElementById('footFill');
const footNum        = document.getElementById('footNum');
const toastEl        = document.getElementById('toast');
const confettiEl     = document.getElementById('confetti');

datePicker.valueAsDate = new Date();

let uid=null, unsubDay=null, dayCache=null, lastMilestoneShown=0;

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
btnSignUp.onclick = async ()=>{ try{ await auth.createUserWithEmailAndPassword(emailEl.value.trim(), pwdEl.value); alert('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω, –≤—ã –≤–æ—à–ª–∏.'); }catch(e){ alert(e.message); } };
btnSignIn.onclick = async ()=>{ try{ await auth.signInWithEmailAndPassword(emailEl.value.trim(), pwdEl.value); }catch(e){ alert(e.message); } };
btnReset.onclick  = async ()=>{ try{ await auth.sendPasswordResetEmail(emailEl.value.trim()); alert('–ü–∏—Å—å–º–æ –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.'); }catch(e){ alert(e.message); } };
btnLogout.onclick = async ()=>{ if (unsubDay){unsubDay();unsubDay=null} await auth.signOut(); };

auth.onAuthStateChanged(user=>{
  if (user){
    uid = user.uid;
    authState.textContent = '–≤ —Å–µ—Ç–∏';
    userInfo.textContent  = user.email ? ` ¬∑ ${user.email}` : '';
    btnLogout.style.display=''; btnSignIn.style.display='none'; btnSignUp.style.display='none'; btnReset.style.display='none'; emailEl.style.display='none'; pwdEl.style.display='none';
    btnExportDay.disabled=false; btnExportAll.disabled=false;
    attachDayListener(datePicker.value);
  } else {
    uid = null;
    authState.textContent = '–Ω–µ –≤–æ—à–ª–∞';
    userInfo.textContent  = '';
    btnLogout.style.display='none'; btnSignIn.style.display=''; btnSignUp.style.display=''; btnReset.style.display=''; emailEl.style.display=''; pwdEl.style.display='';
    btnExportDay.disabled=true; btnExportAll.disabled=true;
    if (unsubDay){unsubDay();unsubDay=null}
    dayCache=null; lastMilestoneShown=0; renderTable();
  }
});

/* ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function attachDayListener(dateStr){
  if (!uid) return;
  if (unsubDay){unsubDay();unsubDay=null}
  unsubDay = dayRef(uid,dateStr).onSnapshot(async snap=>{
    if (snap.exists){
      dayCache = normalizeSlots(snap.data().slots||[]);
    } else{
      const slots = emptyDay();
      await dayRef(uid,dateStr).set({slots, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
      dayCache = slots;
    }
    renderTable(true);  // true = –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ –¥–Ω—è
  }, err=>console.error(err));
}

function currentSlotIndex(dateStr){
  const now = new Date();
  const isToday = dateStr === now.toISOString().slice(0,10);
  return isToday ? Math.floor((now.getHours()*60+now.getMinutes())/15) : -1;
}

/* ‚îÄ‚îÄ UI RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderTable(autoScroll=false){
  const dateStr = datePicker.value;
  const slots = dayCache || emptyDay();
  const curr = currentSlotIndex(dateStr);

  // —Å—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–∏
  const total = slots.reduce((a,s)=>a+(Number(s.count)||0),0);
  const sleptSlots = slots.filter(s=>s.sleep).length;
  const sleptHours = +(sleptSlots/4).toFixed(2);
  const forgotCnt  = slots.filter(s=>s.forgot).length;

  // —Ç–∞–±–ª–∏—Ü–∞ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ ¬´–æ—Å—Ç–∞–ª–æ—Å—å –¥–æ —Ü–µ–ª–∏¬ª –∫–∞–∂–¥—ã–µ 8 —Å–ª–æ—Ç–æ–≤
  let html = '<table><thead><tr><th>–í—Ä–µ–º—è</th><th>–í–ô</th><th>–°–æ–Ω</th><th>–ó–∞–±—ã–ª</th><th>–°–∫–æ–ª—å–∫–æ —Ä–∞–∑</th></tr></thead><tbody>';
  slots.forEach((s,idx)=>{
    // –∫–∞–∂–¥—ã–µ 8 —Å–ª–æ—Ç–æ–≤ ‚Äî –º–∞—Ä–∫–µ—Ä
    if (idx%8===0 && idx>0){
      const remain = Math.max(0, 100-total);
      const pct = Math.min(100, Math.round(total/100*100));
      html += `<tr class="marker-row"><td colspan="5">
        <div class="marker">
          <span>–î–æ —Ü–µ–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å: <b>${remain}</b></span>
          <div class="bar"><i style="width:${pct}%; background:${progressColor(pct)}"></i></div>
          <span style="font-size:12px;color:#111">${total}/100</span>
        </div>
      </td></tr>`;
    }

    const cls = idx===curr ? 'current-slot' : '';
    html += `<tr class="${cls}">
      <td>${s.time}</td>
      <td><button class="btn btn-sm btn-green" data-act="plus" data-idx="${idx}">+1</button></td>
      <td><button class="btn btn-sm btn-gray"  data-act="sleep" data-idx="${idx}" aria-pressed="${s.sleep}">${s.sleep?'–°–æ–Ω ‚úì':'–°–æ–Ω'}</button></td>
      <td><button class="btn btn-sm btn-yellow" data-act="forgot" data-idx="${idx}" aria-pressed="${s.forgot}">${s.forgot?'–ó–∞–±—ã–ª ‚úì':'–ó–∞–±—ã–ª'}</button></td>
      <td id="c_${idx}">${s.count}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  tableContainer.innerHTML = html;

  // —Ñ—É—Ç–µ—Ä + –≤–µ—Ä—Ö–Ω–∏–π –º–∏–Ω–∏‚Äë–±–∞—Ä
  const pct = Math.min(100, Math.round(total/100*100));
  statsDiv.firstChild.textContent = `–ò—Ç–æ–≥–æ +1: ${total} ¬∑ –°–æ–Ω: ${sleptHours} —á ¬∑ –ó–∞–±—ã–ª–∞: ${forgotCnt} —Å–ª–æ—Ç–æ–≤`;
  footFill.style.width = pct+'%';
  footFill.style.background = progressColor(pct);
  footNum.textContent = `${total}/100 (${pct}%)`;
  miniFill.style.width = pct+'%';
  miniFill.style.background = progressColor(pct);
  miniChip.textContent = `${total}/100`;

  // –≤–µ—Ö–∏
  maybeMilestone(total);

  // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ —Ç–µ–∫—É—â–µ–º—É —Å–ª–æ—Ç—É (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ/—Å–º–µ–Ω–µ –¥–Ω—è)
  if (autoScroll && curr>=0){
    const rows = tableContainer.querySelectorAll('tbody tr');
    // —É—á–µ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã: –∫–∞–∂–¥—ã–µ 8 —Å–ª–æ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∏–º 1 –º–∞—Ä–∫–µ—Ä‚Äë—Å—Ç—Ä–æ–∫–∞
    const offset = Math.floor(curr/8); 
    const row = rows[curr + offset];
    if (row) row.scrollIntoView({behavior:'smooth', block:'center'});
  }
}

// –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function progressColor(pct){
  if (pct>=100) return 'var(--bar4)';   // –∑–æ–ª–æ—Ç–æ
  if (pct>=67)  return 'var(--bar1)';   // –∑–µ–ª—ë–Ω—ã–π
  if (pct>=34)  return 'var(--bar3)';   // –±–∏—Ä—é–∑–æ–≤—ã–π
  return 'var(--bar0)';                 // —Å–µ—Ä–æ‚Äë—Å–∏–Ω–∏–π
}

/* ‚îÄ‚îÄ interactions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
tableContainer.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-act]');
  if (!btn || !uid) return;
  const act = btn.dataset.act;
  const idx = +btn.dataset.idx;

  const slots = (dayCache || emptyDay()).slice();

  if (act==='plus'){
    slots[idx].count = Number(slots[idx].count||0)+1;
    dayCache = slots;
    const cell = document.getElementById(`c_${idx}`); if (cell) cell.textContent = slots[idx].count;
  }
  if (act==='sleep'){
    slots[idx].sleep = !slots[idx].sleep;
    dayCache = slots;
  }
  if (act==='forgot'){
    slots[idx].forgot = !slots[idx].forgot;
    dayCache = slots;
  }

  renderTable(false);
  try{
    await dayRef(uid,datePicker.value).set({slots: normalizeSlots(slots), updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
  }catch(err){ console.error(err); }
});

// –æ—Ç–º–µ—Ç–∏—Ç—å –°–æ–Ω –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
btnSleep.addEventListener('click', async ()=>{
  if (!uid) return;
  const dateStr = datePicker.value;
  const slots = (dayCache || emptyDay()).slice();
  const limit = currentSlotIndex(dateStr);
  const upto = (limit<0? 0 : limit); // –µ—Å–ª–∏ –Ω–µ —Å–µ–≥–æ–¥–Ω—è ‚Äî –Ω–∏—á–µ–≥–æ
  for (let i=0;i<upto;i++) slots[i].sleep = true;
  dayCache = slots;
  renderTable(false);
  await dayRef(uid,dateStr).set({slots: normalizeSlots(slots), updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
});

/* ‚îÄ‚îÄ milestones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function maybeMilestone(total){
  for (const m of MILESTONES){
    if (total>=m && lastMilestoneShown<m){
      lastMilestoneShown = m;
      if (m===100){ confetti(); toast(`100/100! üåü –ë—Ä–∞–≤–æ!`); }
      else { toast(`${m}/100 ‚Äî –æ—Ç–ª–∏—á–Ω–æ!`); }
    }
  }
}
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1600);
}
function confetti(){
  confettiEl.innerHTML = '';
  const icons = ['‚ú®','üíö','üü¢','üåø','üí´','üß°','üåü','ü™Ñ'];
  const n = 28;
  for (let i=0;i<n;i++){
    const s = document.createElement('span');
    s.textContent = icons[i%icons.length];
    s.style.left = (Math.random()*100)+'vw';
    s.style.setProperty('--dx', (Math.random()*60-30)+'px');
    confettiEl.appendChild(s);
    setTimeout(()=>s.remove(), 1600);
  }
}

/* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('exportDay').addEventListener('click', async ()=>{
  if (!uid) return;
  const dateStr = datePicker.value;
  const snap = await dayRef(uid,dateStr).get();
  const slots = normalizeSlots(snap.exists ? (snap.data().slots||[]) : []);
  exportCSV({[dateStr]:slots}, `vajrayogini_${dateStr}.csv`);
});
document.getElementById('exportAll').addEventListener('click', async ()=>{
  if (!uid) return;
  const snap = await db.collection('users').doc(uid).collection('days').get();
  const obj={}; snap.forEach(d=>obj[d.id]=normalizeSlots(d.data().slots||[]));
  exportCSV(obj, `vajrayogini_all.csv`);
});
function exportCSV(obj,filename){
  const rows=[['–î–∞—Ç–∞','–í—Ä–µ–º—è','–í–ô (+1)','–°–æ–Ω','–ó–∞–±—ã–ª']];
  for (const [date,slots] of Object.entries(obj)){
    (slots||[]).forEach(s=>rows.push([date,s.time,Number(s.count||0), s.sleep?'–î–∞':'–ù–µ—Ç', s.forgot?'–î–∞':'–ù–µ—Ç']));
  }
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}

/* ‚îÄ‚îÄ date change ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
datePicker.addEventListener('change', ()=>{
  lastMilestoneShown = 0;
  if (uid) attachDayListener(datePicker.value); else renderTable(true);
});

/* –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –µ—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–∞ */
renderTable(true);
</script>
</body>
</html>
